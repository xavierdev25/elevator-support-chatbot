import re
from typing import Dict, List, Optional, Tuple
from business_info import BUSINESS_INFO

class ElevatorChatbot:
    def __init__(self):
        self.conversation_state = {
            "equipment_type": None,  # "ascensor" o "escalera"
            "brand": None,
            "sector": None,
            "age": None,
            "confirmed_brand": False,
            "confirmed_equipment": False,
            "waiting_for_confirmation": False,
            "service_type": None,  # "mantenimiento" o "modernizacion"
            "modernization_scope": None  # "basica" o "completa"
        }
        self.reset_conversation()
    
    def reset_conversation(self):
        """Reinicia el estado de la conversaci√≥n"""
        self.conversation_state = {
            "equipment_type": None,
            "brand": None,
            "sector": None,
            "age": None,
            "confirmed_brand": False,
            "confirmed_equipment": False,
            "waiting_for_confirmation": False,
            "service_type": None,
            "modernization_scope": None
        }
    
    def normalize_text(self, text: str) -> str:
        """Normaliza el texto para comparaciones"""
        return text.lower().strip()
    
    def find_best_match(self, user_input: str, options: List[str]) -> Optional[str]:
        """Encuentra la mejor coincidencia entre la entrada del usuario y las opciones disponibles"""
        normalized_input = self.normalize_text(user_input)
        
        # Coincidencias exactas
        for option in options:
            if self.normalize_text(option) == normalized_input:
                return option
        
        # Coincidencias parciales
        for option in options:
            normalized_option = self.normalize_text(option)
            if normalized_option in normalized_input or normalized_input in normalized_option:
                return option
        
        # Coincidencias por similitud (para casos como "asensor" -> "Ascensor")
        common_mistakes = {
            "asensor": "Ascensor",
            "ascensor": "Ascensor",
            "elevador": "Ascensor",
            "escalera": "Escalera el√©ctrica",
            "escalera electrica": "Escalera el√©ctrica",
            "parte mecanica": "parte mec√°nica",
            "parte mecanica": "parte mec√°nica",
            "sistema electronico": "sistema electr√≥nico",
            "sistema electronico": "sistema electr√≥nico",
            "yaskawa": "Yaskawa",
            "otis": "Otis",
            "schindler": "Schindler",
            "kone": "Kone",
            "orona": "Orona",
            "mitsubishi": "Mitsubishi",
            "thyssenkrupp": "Thyssenkrupp",
            "hyundai": "Hyundai",
            "omega": "Omega",
            "fujiyida": "Fujiyida",
            "wilcox": "Wilcox",
            "kuesta": "cuesta",
            "kosto": "costo",
            "ke": "que",
            "k": "que",
            "komponente": "componente",
            "kontakto": "contacto",
            "kontrato": "contrato",
            "kotizacion": "cotizaci√≥n",
            "diagnostiko": "diagn√≥stico",
            "kita": "cita",
            "tecniko": "t√©cnico",
            "grasias": "gracias",
            "ola": "hola",
            "kede": "qued√©",
            "k tal": "qu√© tal",
            "buenos dias": "buenos d√≠as",
            "buen dia": "buen d√≠a",
            "electroniko": "electr√≥nico",
            "electronica": "electr√≥nica",
            "modernizacion": "modernizaci√≥n",
            "renovacion": "renovaci√≥n",
            "atencion": "atenci√≥n",
            "informacion": "informaci√≥n",
            "revision": "revisi√≥n",
            "servicio": "servicio",
            "mantenimiento": "mantenimiento",
            "emergencia": "emergencia",
            "ayuda": "ayuda",
            "problema": "problema",
            "ruido": "ruido",
            "lento": "lento",
            "puerta": "puerta",
            "boton": "bot√≥n",
            "funciona": "funciona",
            "no funciona": "no funciona"
        }
        
        # Buscar coincidencias con errores ortogr√°ficos
        for mistake, correction in common_mistakes.items():
            if mistake in normalized_input:
                # Reemplazar el error con la correcci√≥n
                corrected_input = normalized_input.replace(mistake, correction)
                # Buscar coincidencia con la entrada corregida
                for option in options:
                    if self.normalize_text(option) == corrected_input:
                        return option
                    normalized_option = self.normalize_text(option)
                    if corrected_input in normalized_option or normalized_option in corrected_input:
                        return option
        
        # Buscar coincidencias directas con errores comunes
        return common_mistakes.get(normalized_input)
    
    def validate_age(self, age_input: str) -> Optional[int]:
        """Valida que la edad sea un n√∫mero entre 1 y 50"""
        try:
            age = int(age_input)
            if 1 <= age <= 50:
                return age
            return None
        except ValueError:
            return None
    
    def calculate_maintenance_price(self) -> int:
        """Calcula el precio del mantenimiento basado en los datos recopilados"""
        if not all([self.conversation_state["equipment_type"], 
                   self.conversation_state["brand"], 
                   self.conversation_state["sector"], 
                   self.conversation_state["age"]]):
            return 0
        
        equipment_type = self.conversation_state["equipment_type"]
        brand = self.conversation_state["brand"]
        sector = self.conversation_state["sector"]
        age = self.conversation_state["age"]
        
        pricing = BUSINESS_INFO["maintenance_pricing"][equipment_type]
        
        # Precio base por marca
        base_price = pricing["by_brand"].get(brand, pricing["base"])
        
        # Ajuste por sector
        sector_adjustment = pricing["sector_adjustment"].get(sector, 0)
        
        # Ajuste por edad
        age_adjustment = 0
        for age_range in pricing["age_adjustment"]:
            if age_range["min"] <= age <= age_range["max"]:
                age_adjustment = age_range["adjustment"]
                break
        
        total_price = base_price + sector_adjustment + age_adjustment
        return total_price
    
    def calculate_modernization_price(self) -> dict:
        """Calcula el precio de modernizaci√≥n basado en el tipo de equipo y alcance"""
        equipment_type = self.conversation_state["equipment_type"]
        scope = self.conversation_state["modernization_scope"]
        
        if not equipment_type or not scope:
            return None
        
        pricing = BUSINESS_INFO["modernization_pricing"][equipment_type]
        
        if scope == "basica":
            return {
                "usd_range": f"${pricing['basic']['usd_min']:,} - ${pricing['basic']['usd_max']:,} USD",
                "soles_range": f"S/. {pricing['basic']['soles_min']:,} - S/. {pricing['basic']['soles_max']:,} soles",
                "description": pricing['basic']['description']
            }
        elif scope == "completa":
            return {
                "usd_range": f"${pricing['complete']['usd_min']:,} - ${pricing['complete']['usd_max']:,} USD",
                "soles_range": f"S/. {pricing['complete']['soles_min']:,} - S/. {pricing['complete']['soles_max']:,} soles",
                "description": pricing['complete']['description']
            }
        
        return None
    
    def generate_modernization_info(self) -> str:
        """Genera informaci√≥n completa sobre modernizaci√≥n"""
        equipment_type = self.conversation_state["equipment_type"]
        equipment_display = "Ascensor" if equipment_type == "ascensor" else "Escalera el√©ctrica"
        
        pricing = BUSINESS_INFO["modernization_pricing"][equipment_type]
        
        info = (
            f"üèóÔ∏è **MODERNIZACI√ìN DE {equipment_display.upper()}**\n\n"
            f"**Factores que influyen en el precio:**\n"
        )
        
        for factor in BUSINESS_INFO["modernization_factors"]:
            info += f"‚Ä¢ {factor}\n"
        
        info += f"\n**Costos estimados:**\n"
        info += f"‚Ä¢ **Modernizaci√≥n B√°sica:** ${pricing['basic']['usd_min']:,} - ${pricing['basic']['usd_max']:,} USD / S/. {pricing['basic']['soles_min']:,} - S/. {pricing['basic']['soles_max']:,} soles\n"
        info += f"‚Ä¢ **Proyecto Completo:** ${pricing['complete']['usd_min']:,} - ${pricing['complete']['usd_max']:,} USD / S/. {pricing['complete']['soles_min']:,} - S/. {pricing['complete']['soles_max']:,} soles\n"
        info += f"‚Ä¢ **Promedio en Lima:** S/. {pricing['average_soles']['min']:,} - S/. {pricing['average_soles']['max']:,} soles\n\n"
        
        info += f"**Beneficios de modernizar:**\n"
        for benefit in BUSINESS_INFO["modernization_benefits"]:
            info += f"‚Ä¢ {benefit}\n"
        
        info += f"\n**¬øC√≥mo obtener una cotizaci√≥n precisa?**\n"
        info += BUSINESS_INFO["modernization_quote_info"]
        
        info += f"\n\nüìû **Contacto:**\n"
        info += f"‚Ä¢ Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
        info += f"‚Ä¢ Email: {BUSINESS_INFO['contact_email']}\n"
        info += f"‚Ä¢ Horario: {BUSINESS_INFO['hours']}"
        
        return info
    
    def handle_modernization_request(self, user_input: str) -> str:
        """Maneja las consultas espec√≠ficas de modernizaci√≥n"""
        normalized_input = self.normalize_text(user_input)
        
        # Selecci√≥n de tipo de equipo para modernizaci√≥n
        if not self.conversation_state["equipment_type"]:
            if "ascensor" in normalized_input or "asensor" in normalized_input or "elevador" in normalized_input:
                self.conversation_state["equipment_type"] = "ascensor"
                return "¬øQu√© tipo de modernizaci√≥n desea? (B√°sica o Completa)"
            elif "escalera" in normalized_input:
                self.conversation_state["equipment_type"] = "escalera"
                return "¬øQu√© tipo de modernizaci√≥n desea? (B√°sica o Completa)"
            else:
                return "Por favor, especifica si desea modernizaci√≥n para Ascensor o Escalera el√©ctrica."
        
        # Selecci√≥n del alcance de modernizaci√≥n
        if not self.conversation_state["modernization_scope"]:
            if "basica" in normalized_input or "b√°sica" in normalized_input or "basico" in normalized_input or "b√°sico" in normalized_input:
                self.conversation_state["modernization_scope"] = "basica"
                return self.generate_modernization_info()
            elif "completa" in normalized_input or "completo" in normalized_input or "integral" in normalized_input:
                self.conversation_state["modernization_scope"] = "completa"
                return self.generate_modernization_info()
            else:
                return "Por favor selecciona el tipo de modernizaci√≥n: B√°sica (renovaci√≥n de componentes esenciales) o Completa (proyecto integral con mejora est√©tica)"
        
        # Si ya tenemos toda la informaci√≥n, mostrar la informaci√≥n
        return self.generate_modernization_info()
    
    def get_response(self, user_input: str) -> str:
        """Procesa la entrada del usuario y devuelve la respuesta apropiada"""
        normalized_input = self.normalize_text(user_input)
        
        # EMERGENCIAS - PRIORIDAD M√ÅXIMA
        if any(word in normalized_input for word in ["atrapada", "atrapado", "atrapada en", "atrapado en", "emergencia", "ayuda urgente", "asustada", "asustado", "kede", "qued√©", "kede atrapada", "qued√© atrapada", "ayuda ya", "ayuda inmediata", "socorro", "urgente"]):
            return self.handle_emergency(user_input)
        
        # Saludos iniciales
        if any(greeting in normalized_input for greeting in ["hola", "buenos dias", "buenas", "buen dia"]):
            return "¬°Hola! üòä ¬øEn qu√© puedo ayudarte hoy?\n\nPuedo asistirte con:\n‚Ä¢ üõ†Ô∏è **Mantenimiento** de ascensores y escaleras el√©ctricas\n‚Ä¢ üèóÔ∏è **Modernizaci√≥n** de equipos\n‚Ä¢ üÜò **Emergencias** 24/7\n‚Ä¢ üí∞ **Cotizaciones** y precios\n‚Ä¢ ‚ùì **Preguntas frecuentes**\n\n¬øQu√© servicio necesitas?"
        
        # PREGUNTAS FRECUENTES ESPEC√çFICAS
        if "cuanto cuesta" in normalized_input and "ascensor" in normalized_input and "marca" in normalized_input:
            return self.handle_brand_price_query(user_input)
        
        if "que ascensor me recomiendas" in normalized_input or "que ascensor recomiendas" in normalized_input:
            return self.handle_recommendation_query(user_input)
        
        if "persona discapacitada" in normalized_input or "discapacidad" in normalized_input:
            return self.handle_disability_query()
        
        if "colegio" in normalized_input and ("cuanto" in normalized_input or "costo" in normalized_input):
            return self.handle_school_elevator_query()
        
        if "modernizacion" in normalized_input and "ascensor" in normalized_input and ("cuanto" in normalized_input or "costo" in normalized_input):
            return self.handle_elevator_modernization_query()
        
        if "contactar tecnico" in normalized_input or "tecnico" in normalized_input:
            return self.handle_technician_contact()
        
        if "agendar" in normalized_input or "cita" in normalized_input or "programar" in normalized_input:
            return self.handle_appointment_request()
        
        # NUEVAS CONSULTAS ESPEC√çFICAS
        if "asistencia tecnica" in normalized_input or "asistencia t√©cnica" in normalized_input or "soporte tecnico" in normalized_input or "soporte t√©cnico" in normalized_input:
            return self.handle_technical_support_query()
        
        if ("precio" in normalized_input or "costo" in normalized_input or "cuanto" in normalized_input) and "escalera" in normalized_input:
            return self.handle_escalator_price_query()
        
        # CONSULTAS ESPEC√çFICAS DE ESCALERAS EL√âCTRICAS - PRIORIDAD ALTA
        if ("modernizacion" in normalized_input or "modernizaci√≥n" in normalized_input) and "escalera" in normalized_input:
            return self.handle_escalator_modernization_query()
        
        if "mantenimiento" in normalized_input and "escalera" in normalized_input:
            # Establecer el tipo de servicio y equipo
            self.conversation_state["service_type"] = "mantenimiento"
            self.conversation_state["equipment_type"] = "escalera"
            return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
        
        if ("cotizacion" in normalized_input or "cotizaci√≥n" in normalized_input) and "escalera" in normalized_input:
            return self.handle_escalator_price_query()
        
        if "gracias" in normalized_input or "grasias" in normalized_input:
            return "¬°De nada! üòä Estoy aqu√≠ para ayudarte. Si tienes m√°s preguntas o necesitas asistencia, no dudes en contactarme. ¬°Que tengas un excelente d√≠a!"
        
        # PREGUNTAS FRECUENTES GENERALES
        if "que servicios" in normalized_input or "servicios ofrecen" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["servicios_generales"]["que_servicios"]
        
        if "mantenimiento escaleras" in normalized_input or "escaleras electricas" in normalized_input:
            return "S√≠, ofrecemos mantenimiento completo para escaleras el√©ctricas de todas las marcas principales. Incluye revisi√≥n de componentes mec√°nicos, el√©ctricos y de seguridad."
        
        if "contrato mantenimiento" in normalized_input or "que incluye" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["servicios_generales"]["opciones_mantenimiento"]
        
        if "24 horas" in normalized_input or "emergencia" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["servicios_generales"]["servicio_emergencia"]
        
        if "mantenimiento preventivo" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["mantenimiento"]["mantenimiento_preventivo"]
        
        if "componentes revisan" in normalized_input or "que revisan" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["mantenimiento"]["componentes_revision"]
        
        if "todas marcas" in normalized_input or "trabajan marcas" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["mantenimiento"]["todas_marcas"]
        
        if "mantenimiento correctivo" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["mantenimiento"]["mantenimiento_correctivo"]
        
        if "repuestos" in normalized_input and ("venden" in normalized_input or "originales" in normalized_input):
            return BUSINESS_INFO["faq_responses"]["repuestos_modernizacion"]["venden_repuestos"]
        
        if "ventajas modernizar" in normalized_input or "beneficios modernizar" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["repuestos_modernizacion"]["ventajas_modernizar"]
        
        if "componentes renovar" in normalized_input or "que se puede renovar" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["repuestos_modernizacion"]["componentes_renovar"]
        
        if "ascensores ecologicos" in normalized_input or "gearless" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["ascensores_ecologicos"]["que_son"]
        
        if "por que eficientes" in normalized_input or "eficiencia" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["ascensores_ecologicos"]["por_que_eficientes"]
        
        if "diagnostico gratuito" in normalized_input or "evaluacion" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["diagnostico_proyectos"]["diagnostico_gratuito"]
        
        if "proyectos inconclusos" in normalized_input or "instalacion inconclusa" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["diagnostico_proyectos"]["proyectos_inconclusos"]
        
        if "cotizacion" in normalized_input or "cotizar" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["contacto_cotizaciones"]["solicitar_cotizacion"]
        
        if "horarios" in normalized_input or "atencion" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["contacto_cotizaciones"]["horarios_atencion"]
        
        if "ubicacion" in normalized_input or "donde" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["contacto_cotizaciones"]["ubicacion"]
        
        if "tipos ascensores" in normalized_input or "residenciales comerciales" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["detalles_tecnicos"]["tipos_ascensores"]
        
        if "plataformas discapacitados" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["detalles_tecnicos"]["plataformas_escaleras"]
        
        if "sistemas seguridad" in normalized_input or "seguridad" in normalized_input:
            return BUSINESS_INFO["faq_responses"]["detalles_tecnicos"]["sistemas_seguridad"]
        
        # CONSULTAS DE REPUESTOS ESPEC√çFICOS
        if "repuesto" in normalized_input or "componente" in normalized_input or "variador" in normalized_input or "tarjeta" in normalized_input or "contacto" in normalized_input or "pulsador" in normalized_input:
            return self.handle_spare_parts_query(user_input)
        
        # Detecci√≥n de tipo de servicio (mantenimiento o modernizaci√≥n) - PRIORIDAD ALTA
        if not self.conversation_state["service_type"]:
            if any(word in normalized_input for word in ["modernizacion", "modernizaci√≥n", "renovar", "renovacion", "renovaci√≥n"]):
                self.conversation_state["service_type"] = "modernizacion"
                return "¬øSobre qu√© equipo desea la modernizaci√≥n? (Ascensor o Escalera el√©ctrica)"
            elif "mantenimiento" in normalized_input:
                self.conversation_state["service_type"] = "mantenimiento"
                return "¬øSobre qu√© equipo desea el mantenimiento? (Ascensor o Escalera el√©ctrica)"
        
        # Si es modernizaci√≥n, manejar de forma diferente
        if self.conversation_state["service_type"] == "modernizacion":
            return self.handle_modernization_request(user_input)
        
        # Si es mantenimiento, continuar con el flujo normal
        if self.conversation_state["service_type"] == "mantenimiento":
            # Procesamiento de informaci√≥n completa en una sola entrada (prioridad alta)
            if not self.conversation_state["equipment_type"]:
                # Buscar tipo de equipo en la entrada
                if "ascensor" in normalized_input or "asensor" in normalized_input or "elevador" in normalized_input:
                    self.conversation_state["equipment_type"] = "ascensor"
                elif "escalera" in normalized_input:
                    self.conversation_state["equipment_type"] = "escalera"
                
                # Si se encontr√≥ el tipo de equipo, buscar sector
                if self.conversation_state["equipment_type"]:
                    sector_options = ["cabina", "parte mec√°nica", "sistema electr√≥nico", "todo"]
                    for sector in sector_options:
                        if sector in normalized_input:
                            self.conversation_state["sector"] = sector
                            break
                    
                    # Si se encontr√≥ el sector, buscar marca
                    if self.conversation_state["sector"]:
                        # Verificar si el usuario est√° preguntando por marcas
                        if any(word in normalized_input for word in ["marcas", "que marcas", "qu√© marcas", "marca", "brands"]):
                            equipment_type = self.conversation_state["equipment_type"]
                            if equipment_type == "ascensor":
                                brands = BUSINESS_INFO["elevator_brands"]
                            else:
                                brands = BUSINESS_INFO["escalator_brands"]
                            
                            brands_text = ", ".join(brands)
                            return f"Las marcas disponibles para {equipment_type} son: {brands_text}"
                        
                        equipment_type = self.conversation_state["equipment_type"]
                        if equipment_type == "ascensor":
                            available_brands = BUSINESS_INFO["elevator_brands"]
                        else:
                            available_brands = BUSINESS_INFO["escalator_brands"]
                        
                        for brand in available_brands:
                            if self.normalize_text(brand) in normalized_input:
                                self.conversation_state["brand"] = brand
                                break
                        
                        # Si se encontr√≥ la marca, buscar edad
                        if self.conversation_state["brand"]:
                            # Buscar n√∫meros en el texto
                            import re
                            numbers = re.findall(r'\d+', user_input)
                            if numbers:
                                age = self.validate_age(numbers[0])
                                if age is not None:
                                    self.conversation_state["age"] = age
                                    return self.generate_price_quote()
                            
                            # Si no se encontr√≥ edad, preguntar por ella
                            return "¬øCu√°ntos a√±os de antig√ºedad tiene el equipo? (Por favor, ingrese un n√∫mero entre 1 y 50)"
                        
                        # Si no se encontr√≥ marca, preguntar por ella
                        return "¬øDe qu√© marca es su equipo? (Puedes preguntar '¬øqu√© marcas tienen?' para ver la lista)"
                    
                    # Si no se encontr√≥ sector, preguntar por √©l
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
            
            # Detecci√≥n de cambios de contexto (prioridad alta)
            if self.conversation_state["equipment_type"]:
                # Cambio de ascensor a escalera
                if "escalera" in normalized_input and self.conversation_state["equipment_type"] == "ascensor":
                    self.reset_conversation()
                    self.conversation_state["equipment_type"] = "escalera"
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                
                # Cambio de escalera a ascensor
                if ("ascensor" in normalized_input or "elevador" in normalized_input) and self.conversation_state["equipment_type"] == "escalera":
                    self.reset_conversation()
                    self.conversation_state["equipment_type"] = "ascensor"
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
            
            # Solicitud de mantenimiento
            if "mantenimiento" in normalized_input:
                return "¬øSobre qu√© equipo desea el mantenimiento? (Ascensor o Escalera el√©ctrica)"
            
            # Si estamos esperando confirmaci√≥n de marca
            if self.conversation_state["waiting_for_confirmation"] and self.conversation_state["brand"]:
                if normalized_input in ["si", "s√≠", "yes"]:
                    self.conversation_state["confirmed_brand"] = True
                    self.conversation_state["waiting_for_confirmation"] = False
                    return "¬øCu√°ntos a√±os de antig√ºedad tiene el equipo? (Por favor, ingrese un n√∫mero entre 1 y 50)"
                elif normalized_input in ["no"]:
                    self.conversation_state["brand"] = None
                    self.conversation_state["waiting_for_confirmation"] = False
                    return "¬øDe qu√© marca es su equipo? (Puedes preguntar '¬øqu√© marcas tienen?' para ver la lista)"
                else:
                    return "Por favor responde s√≠ o no."
            
            # Si estamos esperando confirmaci√≥n de equipo
            if self.conversation_state["waiting_for_confirmation"] and self.conversation_state["equipment_type"] == "ascensor":
                if normalized_input in ["si", "s√≠", "yes"]:
                    self.conversation_state["confirmed_equipment"] = True
                    self.conversation_state["waiting_for_confirmation"] = False
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                elif normalized_input in ["no"]:
                    self.conversation_state["equipment_type"] = "escalera"
                    self.conversation_state["confirmed_equipment"] = True
                    self.conversation_state["waiting_for_confirmation"] = False
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                else:
                    return "Por favor responde s√≠ o no."
            
            # Selecci√≥n de tipo de equipo
            if not self.conversation_state["equipment_type"]:
                if "ascensor" in normalized_input or "asensor" in normalized_input or "elevador" in normalized_input:
                    self.conversation_state["equipment_type"] = "ascensor"
                    if "asensor" in normalized_input:
                        self.conversation_state["waiting_for_confirmation"] = True
                        return "¬øQuiz√°s quisiste decir 'Ascensor'? (Responde s√≠ o no)"
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                elif "escalera" in normalized_input:
                    self.conversation_state["equipment_type"] = "escalera"
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                else:
                    return "Por favor, especifica si necesitas mantenimiento para Ascensor o Escalera el√©ctrica."
            
            # Selecci√≥n de sector
            if not self.conversation_state["sector"]:
                sector_options = ["cabina", "parte mec√°nica", "sistema electr√≥nico", "todo"]
                matched_sector = self.find_best_match(user_input, sector_options)
                
                if matched_sector:
                    self.conversation_state["sector"] = matched_sector
                    return "¬øDe qu√© marca es su equipo? (Puedes preguntar '¬øqu√© marcas tienen?' para ver la lista)"
                else:
                    return "Por favor selecciona uno de estos sectores: Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo"
            
            # Consulta de marcas disponibles
            if "marcas" in normalized_input or "que marcas" in normalized_input:
                equipment_type = self.conversation_state["equipment_type"]
                if equipment_type == "ascensor":
                    brands = BUSINESS_INFO["elevator_brands"]
                else:
                    brands = BUSINESS_INFO["escalator_brands"]
                
                brands_text = ", ".join(brands)
                return f"Las marcas disponibles para {equipment_type} son: {brands_text}"
            
            # Selecci√≥n de marca
            if not self.conversation_state["brand"]:
                # Verificar si el usuario quiere cambiar de contexto
                if "no" in normalized_input and ("ascensor" in normalized_input or "elevador" in normalized_input):
                    # Usuario quiere cambiar a ascensor
                    self.conversation_state["equipment_type"] = "ascensor"
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                elif "no" in normalized_input and "escalera" in normalized_input:
                    # Usuario quiere cambiar a escalera
                    self.conversation_state["equipment_type"] = "escalera"
                    return "¬øQu√© sector requiere mantenimiento? (Cabina, Parte mec√°nica, Sistema electr√≥nico, Todo)"
                
                equipment_type = self.conversation_state["equipment_type"]
                if equipment_type == "ascensor":
                    available_brands = BUSINESS_INFO["elevator_brands"]
                else:
                    available_brands = BUSINESS_INFO["escalator_brands"]
                
                matched_brand = self.find_best_match(user_input, available_brands)
                
                if matched_brand:
                    self.conversation_state["brand"] = matched_brand
                    # Verificar si necesita confirmaci√≥n (para casos como "yaskawa" -> "Yaskawa")
                    if self.normalize_text(matched_brand) != self.normalize_text(user_input):
                        self.conversation_state["waiting_for_confirmation"] = True
                        return f"¬øTe refieres a la marca {matched_brand}? (Responde s√≠ o no)"
                    else:
                        return "¬øCu√°ntos a√±os de antig√ºedad tiene el equipo? (Por favor, ingrese un n√∫mero entre 1 y 50)"
                else:
                    return f"Por favor selecciona una marca v√°lida. Puedes preguntar '¬øqu√© marcas tienen?' para ver la lista."
            
            # Edad del equipo
            if not self.conversation_state["age"]:
                age = self.validate_age(user_input)
                if age is not None:
                    self.conversation_state["age"] = age
                    return self.generate_price_quote()
                else:
                    return "Por favor ingresa un n√∫mero v√°lido entre 1 y 50 a√±os."
            
            # Si llegamos aqu√≠, ya tenemos todos los datos
            return self.generate_price_quote()
        
        # Si no se ha especificado el tipo de servicio, preguntar
        return "¬øQu√© tipo de servicio necesitas? (Mantenimiento o Modernizaci√≥n)"
    
    def handle_emergency(self, user_input: str) -> str:
        """Maneja las emergencias de ascensores atrapados"""
        response = "üö® **EMERGENCIA - ASCENSOR ATRAPADO**\n\n"
        
        for step in BUSINESS_INFO["emergency_steps"]:
            response += f"{step}\n"
        
        response += f"\nüìû **CONTACTO INMEDIATO:**\n"
        response += f"‚Ä¢ WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ Nuestro t√©cnico llegar√° en m√°ximo 15 minutos\n\n"
        response += f"‚ö†Ô∏è **NO INTENTES ABRIR LAS PUERTAS MANUALMENTE**\n"
        response += f"üîí **MANT√âN LA CALMA** - Estamos en camino"
        
        return response
    
    def handle_brand_price_query(self, user_input: str) -> str:
        """Maneja consultas de precios por marca"""
        # Extraer marca del input
        normalized_input = self.normalize_text(user_input)
        
        # Buscar marca en el input
        found_brand = None
        for brand in BUSINESS_INFO["elevator_brands"]:
            if self.normalize_text(brand) in normalized_input:
                found_brand = brand
                break
        
        if found_brand:
            # Calcular precio base para la marca
            base_price = BUSINESS_INFO["maintenance_pricing"]["ascensor"]["by_brand"].get(found_brand, 1200)
            
            response = f"üí∞ **PRECIO REFERENCIAL - ASCENSOR {found_brand.upper()}**\n\n"
            response += f"‚Ä¢ **Precio base:** S/. {base_price:,.2f} soles\n"
            response += f"‚Ä¢ **Rango estimado:** S/. {base_price-200:,.2f} - S/. {base_price+300:,.2f} soles\n\n"
            response += f"üí° **Nota:** Este es un precio referencial. El costo final depende de:\n"
            response += f"‚Ä¢ Edad del equipo\n"
            response += f"‚Ä¢ Sector a mantener\n"
            response += f"‚Ä¢ Estado actual del ascensor\n\n"
            response += f"üìû **Para cotizaci√≥n exacta contacta directamente:**\n"
            response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n"
            response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}"
            
            return response
        else:
            return "Por favor especifica la marca del ascensor para darte un precio referencial."
    
    def handle_recommendation_query(self, user_input: str) -> str:
        """Maneja consultas de recomendaciones de ascensores"""
        normalized_input = self.normalize_text(user_input)
        
        if "edificio" in normalized_input:
            rec = BUSINESS_INFO["recommendations"]["edificio"]
        elif "departamento" in normalized_input:
            rec = BUSINESS_INFO["recommendations"]["departamento"]
        else:
            # Recomendaci√≥n general
            rec = BUSINESS_INFO["recommendations"]["edificio"]
        
        response = f"{rec['title']}\n\n"
        response += f"**Recomendaci√≥n:** {rec['recommendation']}\n\n"
        response += f"**¬øPor qu√© esta opci√≥n?**\n"
        
        for reason in rec["reasons"]:
            response += f"‚Ä¢ {reason}\n"
        
        response += f"\n{rec['contact_info']}\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}"
        
        return response
    
    def handle_disability_query(self) -> str:
        """Maneja consultas sobre soluciones para discapacidad"""
        rec = BUSINESS_INFO["recommendations"]["discapacidad"]
        
        response = f"{rec['title']}\n\n"
        response += f"**Soluci√≥n recomendada:** {rec['recommendation']}\n\n"
        response += f"**Caracter√≠sticas:**\n"
        
        for reason in rec["reasons"]:
            response += f"‚Ä¢ {reason}\n"
        
        response += f"\n{rec['contact_info']}\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}"
        
        return response
    
    def handle_school_elevator_query(self) -> str:
        """Maneja consultas sobre ascensores para colegios"""
        rec = BUSINESS_INFO["recommendations"]["colegio"]
        
        response = f"{rec['title']}\n\n"
        response += f"**Recomendaci√≥n:** {rec['recommendation']}\n\n"
        response += f"**Caracter√≠sticas especiales:**\n"
        
        for reason in rec["reasons"]:
            response += f"‚Ä¢ {reason}\n"
        
        response += f"\n**Costo estimado:** S/. 15,000 - S/. 45,000 soles\n"
        response += f"*El precio var√≠a seg√∫n capacidad, pisos y especificaciones*\n\n"
        response += f"{rec['contact_info']}\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}"
        
        return response
    
    def handle_escalator_modernization_query(self) -> str:
        """Maneja consultas sobre modernizaci√≥n de escaleras el√©ctricas"""
        pricing = BUSINESS_INFO["modernization_pricing"]["escalera"]
        
        response = "üèóÔ∏è **MODERNIZACI√ìN DE ESCALERA EL√âCTRICA**\n\n"
        response += f"**Costos estimados:**\n"
        response += f"‚Ä¢ **Modernizaci√≥n B√°sica:** ${pricing['basic']['usd_min']:,} - ${pricing['basic']['usd_max']:,} USD\n"
        response += f"‚Ä¢ **Proyecto Completo:** ${pricing['complete']['usd_min']:,} - ${pricing['complete']['usd_max']:,} USD\n"
        response += f"‚Ä¢ **En soles:** S/. {pricing['average_soles']['min']:,} - S/. {pricing['average_soles']['max']:,}\n\n"
        response += f"**Para cotizaci√≥n precisa contacta:**\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}"
        
        return response
    
    def handle_elevator_modernization_query(self) -> str:
        """Maneja consultas sobre modernizaci√≥n de ascensores"""
        pricing = BUSINESS_INFO["modernization_pricing"]["ascensor"]
        
        response = "üèóÔ∏è **MODERNIZACI√ìN DE ASCENSOR**\n\n"
        response += f"**Costos estimados:**\n"
        response += f"‚Ä¢ **Modernizaci√≥n B√°sica:** ${pricing['basic']['usd_min']:,} - ${pricing['basic']['usd_max']:,} USD\n"
        response += f"‚Ä¢ **Proyecto Completo:** ${pricing['complete']['usd_min']:,} - ${pricing['complete']['usd_max']:,} USD\n"
        response += f"‚Ä¢ **En soles:** S/. {pricing['average_soles']['min']:,} - S/. {pricing['average_soles']['max']:,}\n\n"
        response += f"**Para cotizaci√≥n precisa contacta:**\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}"
        
        return response
    
    def handle_technician_contact(self) -> str:
        """Maneja solicitudes de contacto con t√©cnico"""
        response = "üë®‚Äçüîß **CONTACTO CON T√âCNICO**\n\n"
        response += f"**Para contacto directo con nuestro t√©cnico:**\n\n"
        response += f"üì± **WhatsApp:** {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"üìû **Tel√©fono:** {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"üìß **Email:** {BUSINESS_INFO['contact_email']}\n\n"
        response += f"‚è∞ **Disponibilidad:** 24/7 para emergencias\n"
        response += f"üöó **Tiempo de respuesta:** M√°ximo 15 minutos"
        
        return response
    
    def handle_appointment_request(self) -> str:
        """Maneja solicitudes de agendar citas"""
        response = "üìÖ **AGENDAR MANTENIMIENTO PREVENTIVO**\n\n"
        response += f"**Para agendar tu mantenimiento:**\n\n"
        response += f"üì± **WhatsApp:** {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"üìû **Tel√©fono:** {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"üìß **Email:** {BUSINESS_INFO['contact_email']}\n\n"
        response += f"**Informaci√≥n que necesitamos:**\n"
        response += f"‚Ä¢ Marca y modelo del ascensor\n"
        response += f"‚Ä¢ Direcci√≥n del edificio\n"
        response += f"‚Ä¢ Horario preferido\n"
        response += f"‚Ä¢ Tipo de mantenimiento requerido"
        
        return response
    
    def handle_spare_parts_query(self, user_input: str) -> str:
        """Maneja consultas sobre repuestos espec√≠ficos"""
        normalized_input = self.normalize_text(user_input)
        
        # Buscar categor√≠a de repuesto
        found_category = None
        found_product = None
        
        # Buscar por categor√≠a primero
        for category, products in BUSINESS_INFO["repuestos_pricing"].items():
            category_normalized = self.normalize_text(category)
            if category_normalized in normalized_input:
                found_category = category
                break
        
        # Si no se encontr√≥ categor√≠a, buscar por producto espec√≠fico
        if not found_category:
            for category, products in BUSINESS_INFO["repuestos_pricing"].items():
                for product_name in products.keys():
                    product_normalized = self.normalize_text(product_name)
                    # Buscar coincidencias parciales
                    if any(word in product_normalized for word in normalized_input.split()) or any(word in normalized_input for word in product_normalized.split()):
                        found_product = product_name
                        found_category = category
                        break
                if found_product:
                    break
        
        if found_product:
            # Producto espec√≠fico encontrado
            product_info = BUSINESS_INFO["repuestos_pricing"][found_category][found_product]
            response = f"üîß **REPUESTO: {found_product}**\n\n"
            response += f"**Descripci√≥n:** {product_info['desc']}\n"
            response += f"**Precio:** S/. {product_info['min']:,} - S/. {product_info['max']:,} soles\n\n"
            response += f"**Para compra directa contacta:**\n"
            response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}"
            
            return response
        elif found_category:
            # Categor√≠a encontrada
            products = BUSINESS_INFO["repuestos_pricing"][found_category]
            response = f"üîß **REPUESTOS - {found_category}**\n\n"
            
            for product_name, product_info in products.items():
                response += f"‚Ä¢ **{product_name}:** S/. {product_info['min']:,} - S/. {product_info['max']:,} soles\n"
            
            response += f"\n**Para cotizaci√≥n espec√≠fica contacta:**\n"
            response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}"
            
            return response
        else:
            # Lista general de categor√≠as
            response = "üîß **CATEGOR√çAS DE REPUESTOS DISPONIBLES**\n\n"
            
            for category in BUSINESS_INFO["repuestos_pricing"].keys():
                response += f"‚Ä¢ {category}\n"
            
            response += f"\n**Para consultar precios espec√≠ficos contacta:**\n"
            response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
            response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}"
            
            return response
    
    def generate_price_quote(self) -> str:
        """Genera la cotizaci√≥n de precio final"""
        price = self.calculate_maintenance_price()
        if price == 0:
            return "Lo siento, no se pudo calcular el precio. Por favor, verifica que todos los datos sean correctos."
        
        equipment_type = self.conversation_state["equipment_type"]
        brand = self.conversation_state["brand"]
        sector = self.conversation_state["sector"]
        age = self.conversation_state["age"]
        
        # Formatear el tipo de equipo para mostrar
        equipment_display = "Ascensor" if equipment_type == "ascensor" else "Escalera el√©ctrica"
        
        quote = (
            f"El precio estimado para el mantenimiento de su {equipment_display} marca {brand}, "
            f"sectores {sector}, con {age} a√±os de antig√ºedad es: S/. {price:,.2f} soles.\n\n"
            f"üí° {BUSINESS_INFO['maintenance_warranty']}\n\n"
            f"üìû Para m√°s informaci√≥n o programar una visita, cont√°ctanos:\n"
            f"‚Ä¢ Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
            f"‚Ä¢ Email: {BUSINESS_INFO['contact_email']}\n"
            f"‚Ä¢ Horario: {BUSINESS_INFO['hours']}"
        )
        
        # Reiniciar conversaci√≥n para la pr√≥xima consulta
        self.reset_conversation()
        
        return quote

    def handle_technical_support_query(self) -> str:
        """Maneja consultas sobre asistencia t√©cnica"""
        response = "üõ†Ô∏è **ASISTENCIA T√âCNICA**\n\n"
        response += f"**Nuestros servicios de asistencia t√©cnica incluyen:**\n\n"
        response += f"‚Ä¢ üîß **Diagn√≥stico t√©cnico** gratuito\n"
        response += f"‚Ä¢ üö® **Emergencias 24/7** - Respuesta en 15 minutos\n"
        response += f"‚Ä¢ üìû **Soporte telef√≥nico** especializado\n"
        response += f"‚Ä¢ üë®‚Äçüîß **Visitas t√©cnicas** programadas\n"
        response += f"‚Ä¢ üìã **Reportes t√©cnicos** detallados\n"
        response += f"‚Ä¢ üõ°Ô∏è **Garant√≠a** en todos los servicios\n\n"
        response += f"**Para solicitar asistencia t√©cnica:**\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}\n\n"
        response += f"‚è∞ **Disponibilidad:** 24/7 para emergencias"
        
        return response
    
    def handle_escalator_price_query(self) -> str:
        """Maneja consultas espec√≠ficas sobre precios de escaleras el√©ctricas"""
        pricing = BUSINESS_INFO["maintenance_pricing"]["escalera"]
        
        response = "üí∞ **PRECIOS DE MANTENIMIENTO - ESCALERAS EL√âCTRICAS**\n\n"
        response += f"**Precio base:** S/. {pricing['base']:,} soles\n\n"
        response += f"**Precios por marca:**\n"
        for brand, price in pricing['by_brand'].items():
            response += f"‚Ä¢ {brand}: S/. {price:,} soles\n"
        
        response += f"\n**Ajustes por sector:**\n"
        for sector, adjustment in pricing['sector_adjustment'].items():
            if adjustment > 0:
                response += f"‚Ä¢ {sector.replace('_', ' ').title()}: +S/. {adjustment:,} soles\n"
        
        response += f"\n**Ajustes por antig√ºedad:**\n"
        for age_range in pricing['age_adjustment']:
            if age_range['adjustment'] > 0:
                response += f"‚Ä¢ {age_range['min']}-{age_range['max']} a√±os: +S/. {age_range['adjustment']:,} soles\n"
        
        response += f"\n**Para cotizaci√≥n personalizada contacta:**\n"
        response += f"‚Ä¢ üì± WhatsApp: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìû Tel√©fono: {BUSINESS_INFO['contact_phone_primary']}\n"
        response += f"‚Ä¢ üìß Email: {BUSINESS_INFO['contact_email']}"
        
        return response

def main():
    """Funci√≥n principal para ejecutar el chatbot"""
    chatbot = ElevatorChatbot()
    
    print("ü§ñ Chatbot de Mantenimiento de Ascensores y Escaleras El√©ctricas")
    print("=" * 60)
    print("Escribe 'salir' para terminar la conversaci√≥n")
    print("Escribe 'reiniciar' para comenzar una nueva consulta")
    print("-" * 60)
    
    while True:
        user_input = input("Usuario: ").strip()
        
        if user_input.lower() in ["salir", "exit", "quit"]:
            print("Bot: ¬°Gracias por contactarnos! Que tengas un excelente d√≠a. üëã")
            break
        
        if user_input.lower() in ["reiniciar", "reset", "nuevo"]:
            chatbot.reset_conversation()
            print("Bot: Conversaci√≥n reiniciada. ¬øEn qu√© puedo ayudarte? üòä")
            continue
        
        if not user_input:
            continue
        
        response = chatbot.get_response(user_input)
        print(f"Bot: {response}")
        print("-" * 60)

if __name__ == "__main__":
    main() 